<div class="student-dashboard-shell">
	<app-sidebar class="sidebar-pane" (navigate)="router.navigate([$event])"></app-sidebar>
	<div class="student-dashboard-container main-pane">
		<div class="dashboard-content">
			<div class="container">
				<h1 class="page-title">Welcome back, {{ currentUser?.firstName || 'Alex' }}!</h1>

				<!-- Loading State -->
				<div *ngIf="isLoading" class="loading-state">
					<div class="loading-spinner"></div>
					<p>Loading dashboard data...</p>
				</div>

				<!-- Error State -->
				<div *ngIf="error && !isLoading" class="error-state">
					<div class="error-icon">⚠️</div>
					<h3>Error loading dashboard</h3>
					<p>{{ error }}</p>
					<button class="btn btn-primary" (click)="loadDashboardData()">Retry</button>
				</div>

				<!-- Dashboard Content -->
				<div *ngIf="!isLoading && !error">
					<!-- Quick Stats Section -->
					<div class="quick-stats-section">
						<h2 class="section-title">Quick Stats</h2>
						<div class="quick-stats-cards">
						<div class="quick-stat-card">
							<div class="stat-icon">📅</div>
							<div class="stat-content">
								<div class="stat-title">Upcoming Sessions</div>
								<div class="stat-value">{{ quickStats.upcomingSessions }}</div>
							</div>
						</div>
						<div class="quick-stat-card">
							<div class="stat-icon">✅</div>
							<div class="stat-content">
								<div class="stat-title">Completed Sessions</div>
								<div class="stat-value">{{ quickStats.completedSessions }}</div>
							</div>
						</div>
						<div class="quick-stat-card">
							<div class="stat-icon">❤️</div>
							<div class="stat-content">
								<div class="stat-title">Total Connections</div>
								<div class="stat-value">{{ quickStats.totalConnections }}</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Upcoming Sessions Section -->
				<div class="upcoming-sessions-section">
					<div class="section-header">
						<h2 class="section-title">Upcoming Sessions</h2>
						<button class="btn btn-outline" (click)="browseMentors()">
							<span class="btn-icon">➕</span>
							Book New Session
						</button>
					</div>
					
					<div class="upcoming-sessions-grid" *ngIf="upcomingSessions.length > 0">
						<div class="session-card" *ngFor="let session of upcomingSessions">
							<div class="session-card-header">
								<div class="mentor-avatar">
									<img [src]="getMentorAvatar(session.mentorName)" [alt]="session.mentorName" class="avatar-image">
								</div>
								<div class="session-status-badge">
									<span class="status-dot"></span>
									{{ session.status | titlecase }}
								</div>
							</div>
							
							<div class="session-card-body">
								<h3 class="session-title">{{ session.title || 'Mentoring Session' }}</h3>
								<p class="mentor-name">{{ session.mentorName }}</p>
								<p class="mentor-company">{{ session.mentorCompany }}</p>
								
								<div class="session-details">
									<div class="detail-item">
										<span class="detail-icon">📅</span>
										<span class="detail-text">{{ formatDate(session.date) }}</span>
									</div>
									<div class="detail-item">
										<span class="detail-icon">🕐</span>
										<span class="detail-text">{{ formatTime(session.time) }}</span>
									</div>
									<div class="detail-item">
										<span class="detail-icon">⏱️</span>
										<span class="detail-text">{{ session.duration }} min</span>
									</div>
									<div class="detail-item">
										<span class="detail-icon">💻</span>
										<span class="detail-text">{{ session.sessionType }}</span>
									</div>
								</div>
								
								<div class="session-notes" *ngIf="session.notes">
									<p class="notes-text">{{ session.notes }}</p>
								</div>
							</div>
							
							<div class="session-card-footer">
								<button class="btn btn-primary btn-sm" (click)="viewSession(session.id)" *ngIf="session.meetingLink">
									<span class="btn-icon">🎥</span>
									Join Session
								</button>
								<button class="btn btn-danger btn-sm" (click)="cancelSession(session)" [disabled]="!canCancelSession(session)">
									<span class="btn-icon">❌</span>
									Cancel
								</button>
							</div>
						</div>
					</div>
					
					<div class="empty-state" *ngIf="upcomingSessions.length === 0">
						<div class="empty-icon">📅</div>
						<h3>No upcoming sessions</h3>
						<p>You don't have any sessions scheduled yet. Book a session with a mentor to get started!</p>
						<button class="btn btn-primary" (click)="browseMentors()">
							<span class="btn-icon">➕</span>
							Book New Session
						</button>
					</div>
				</div>

				<!-- Past Sessions Section -->
				<div class="past-sessions-section">
					<div class="section-header">
						<h2 class="section-title">Recent Sessions</h2>
						<button class="btn btn-outline btn-sm" (click)="viewAllSessions()">
							<span class="btn-icon">📋</span>
							View All
						</button>
					</div>
					
					<div class="past-sessions-grid" *ngIf="completedSessions.length > 0">
						<div class="past-session-card" *ngFor="let session of completedSessions; let i = index">
							<div class="past-session-header">
								<div class="past-avatar">
									<img [src]="getMentorAvatar(session.mentorName)" [alt]="session.mentorName" class="past-avatar-image">
								</div>
								<div class="session-rating" *ngIf="session.rating">
									<div class="stars">
										<span *ngFor="let star of getStars(session.rating)" class="star">{{ star }}</span>
									</div>
									<span class="rating-text">{{ session.rating }}/5</span>
								</div>
							</div>
							
							<div class="past-session-body">
								<h4 class="past-session-title">{{ session.title || 'Mentoring Session' }}</h4>
								<p class="past-mentor-name">{{ session.mentorName }}</p>
								<p class="past-mentor-company">{{ session.mentorCompany }}</p>
								<div class="past-session-date">{{ formatDate(session.date) }}</div>
								<div class="past-session-type">{{ session.sessionType }}</div>
							</div>
							
							<div class="past-session-footer">
								<button class="btn btn-outline btn-sm" (click)="rateSession(session)">
									<span class="btn-icon">⭐</span>
									Rate Session
								</button>
							</div>
						</div>
					</div>
					
					<div class="empty-state" *ngIf="completedSessions.length === 0">
						<div class="empty-icon">📚</div>
						<h3>No completed sessions yet</h3>
						<p>Your completed sessions will appear here after you finish your first mentoring session.</p>
					</div>
				</div>

				<!-- Cancelled Sessions Section -->
				<div class="dashboard-section">
					<div class="section-header">
						<h2 class="section-title">Cancelled Sessions</h2>
						<div class="session-count" *ngIf="cancelledSessions.length > 0">
							{{ cancelledSessions.length }} session{{ cancelledSessions.length !== 1 ? 's' : '' }}
						</div>
					</div>
					
					<div class="sessions-grid" *ngIf="cancelledSessions.length > 0; else noCancelledSessions">
						<div class="session-card cancelled-session" *ngFor="let session of cancelledSessions">
							<!-- Session Header -->
							<div class="session-card-header">
								<div class="session-status">
									<span class="status-badge cancelled">Cancelled</span>
								</div>
								<div class="cancelled-by-tag" [ngClass]="getCancelledByClass(session)">
									{{ getCancelledByTag(session) }}
								</div>
							</div>
							
							<!-- Session Body -->
							<div class="session-card-body">
								<h3 class="session-title">{{ session.title }}</h3>
								
								<!-- Mentor Info for Students -->
								<div class="user-info">
									<p class="user-name">{{ session.mentorName }}</p>
									<p class="user-company">{{ session.mentorCompany }}</p>
								</div>
								
								<!-- Session Details -->
								<div class="session-details">
									<div class="detail-item">
										<span class="detail-icon">📅</span>
										<span class="detail-text">{{ formatDate(session.scheduledDate || session.date) }}</span>
									</div>
									<div class="detail-item">
										<span class="detail-icon">🕐</span>
										<span class="detail-text">{{ formatTime(session.scheduledDate || session.date) }}</span>
									</div>
									<div class="detail-item">
										<span class="detail-icon">⏱️</span>
										<span class="detail-text">{{ session.duration }} min</span>
									</div>
									<div class="detail-item">
										<span class="detail-icon">💻</span>
										<span class="detail-text">{{ session.sessionType }}</span>
									</div>
								</div>
								
								<!-- Cancellation Info -->
								<div class="cancellation-info">
									<p class="cancellation-date">Cancelled on: {{ formatDate(session.cancelledAt!) }} at {{ formatTime(session.cancelledAt!) }}</p>
									<p class="cancellation-reason" *ngIf="session.cancellationReason">Reason: {{ session.cancellationReason }}</p>
								</div>
							</div>
						</div>
					</div>
					
					<ng-template #noCancelledSessions>
						<div class="empty-state">
							<div class="empty-icon">🚫</div>
							<h3>No cancelled sessions</h3>
							<p>Any sessions that are cancelled will appear here.</p>
						</div>
					</ng-template>
				</div>
				</div> <!-- End Dashboard Content -->
			</div>
		</div>
	</div>
</div>

<!-- Rate Session Modal -->
<div class="modal-overlay" *ngIf="showRateModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Rate Session</h3>
      <button class="close-btn" (click)="closeRateModal()">×</button>
    </div>
    <div class="modal-body">
      <div class="rating-stars">
        <button class="star"
                *ngFor="let s of [1,2,3,4,5]"
                [class.active]="(hoverRating || currentRating) >= s"
                (click)="setRating(s)"
                (mouseenter)="hoverRating = s"
                (mouseleave)="hoverRating = 0">
          {{ (hoverRating || currentRating) >= s ? '★' : '☆' }}
        </button>
      </div>

      <div class="form-group">
        <label for="feedback">Feedback (optional)</label>
        <textarea id="feedback" [(ngModel)]="currentFeedback" rows="4" placeholder="Share your experience..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeRateModal()">Cancel</button>
      <button class="btn btn-primary" [disabled]="isSubmittingRating || currentRating === 0" (click)="submitRating()">
        <span *ngIf="!isSubmittingRating">Submit</span>
        <span *ngIf="isSubmittingRating">Submitting...</span>
      </button>
    </div>
  </div>
</div>

<!-- Cancel Session Modal -->
<app-cancel-session-modal
	*ngIf="showCancelModal"
	[session]="sessionToCancel"
	[isLoading]="isCancelling"
	(confirm)="onCancelModalConfirm($event)"
	(cancel)="onCancelModalCancel()"
	(success)="onCancelModalSuccess()">
</app-cancel-session-modal>
